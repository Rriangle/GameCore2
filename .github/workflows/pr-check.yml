name: Pull Request Quality Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´æ­·å²è¨˜éŒ„ï¼Œç”¨æ–¼åˆ†æè®Šæ›´

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    # å¾Œç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    - name: Backend Code Quality
      run: |
        echo "=== å¾Œç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ==="
        
        # é‚„åŸå¥—ä»¶
        dotnet restore
        
        # å»ºç½®æª¢æŸ¥
        dotnet build --configuration Release --no-restore
        
        # ç¨‹å¼ç¢¼åˆ†æ
        dotnet tool install --global dotnet-format
        dotnet format --verify-no-changes --verbosity normal
        
        # ç¨‹å¼ç¢¼è¤‡é›œåº¦æª¢æŸ¥
        dotnet tool install --global dotnet-outdated-tool
        dotnet outdated --fail-on-updates
        
        echo "âœ… å¾Œç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ"

    # å‰ç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    - name: Frontend Code Quality
      run: |
        echo "=== å‰ç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ==="
        cd frontend
        
        # å®‰è£ä¾è³´
        pnpm install --frozen-lockfile
        
        # TypeScript å‹åˆ¥æª¢æŸ¥
        pnpm type-check
        
        # ESLint æª¢æŸ¥
        pnpm lint
        
        # ç¨‹å¼ç¢¼æ ¼å¼æª¢æŸ¥
        pnpm format:check
        
        # ä¾è³´å®‰å…¨æ€§æª¢æŸ¥
        pnpm audit --audit-level moderate
        
        echo "âœ… å‰ç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ"

    # æäº¤è¨Šæ¯æ ¼å¼æª¢æŸ¥
    - name: Commit Message Check
      uses: actions/github-script@v7
      with:
        script: |
          const { data: commits } = await github.rest.pulls.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+/;
          const invalidCommits = commits.filter(commit => 
            !conventionalCommitRegex.test(commit.commit.message.split('\n')[0])
          );
          
          if (invalidCommits.length > 0) {
            core.setFailed(`ç™¼ç¾ ${invalidCommits.length} å€‹ä¸ç¬¦åˆè¦ç¯„çš„æäº¤è¨Šæ¯`);
            console.log('ä¸ç¬¦åˆè¦ç¯„çš„æäº¤:');
            invalidCommits.forEach(commit => {
              console.log(`- ${commit.sha.substring(0, 7)}: ${commit.commit.message.split('\n')[0]}`);
            });
          } else {
            console.log('âœ… æ‰€æœ‰æäº¤è¨Šæ¯éƒ½ç¬¦åˆè¦ç¯„');
          }

  # æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥
  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: "YourStrong@Passw0rd"
          ACCEPT_EULA: "Y"
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 1433:1433

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    # å¾Œç«¯æ¸¬è©¦è¦†è“‹ç‡
    - name: Backend Test Coverage
      run: |
        echo "=== å¾Œç«¯æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥ ==="
        
        dotnet restore
        dotnet build --configuration Release --no-restore
        
        # åŸ·è¡Œæ¸¬è©¦ä¸¦æ”¶é›†è¦†è“‹ç‡
        dotnet test --no-build --verbosity normal --configuration Release --collect:"XPlat Code Coverage" --results-directory ./TestResults
        
        # æª¢æŸ¥è¦†è“‹ç‡å ±å‘Š
        dotnet tool install --global dotnet-reportgenerator-globaltool
        reportgenerator -reports:./TestResults/**/coverage.cobertura.xml -targetdir:./TestResults/CoverageReport -reporttypes:Html
        
        echo "âœ… å¾Œç«¯æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥å®Œæˆ"

    # å‰ç«¯æ¸¬è©¦è¦†è“‹ç‡
    - name: Frontend Test Coverage
      run: |
        echo "=== å‰ç«¯æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥ ==="
        cd frontend
        
        pnpm install --frozen-lockfile
        pnpm test:coverage
        
        # æª¢æŸ¥è¦†è“‹ç‡æ˜¯å¦é”åˆ°è¦æ±‚
        COVERAGE=$(cat coverage/lcov.info | grep -E "^SF:" | wc -l)
        if [ $COVERAGE -lt 10 ]; then
          echo "âš ï¸  è­¦å‘Š: æ¸¬è©¦è¦†è“‹ç‡è¼ƒä½"
        else
          echo "âœ… æ¸¬è©¦è¦†è“‹ç‡ç¬¦åˆè¦æ±‚"
        fi

    # ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
    - name: Upload Coverage Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          TestResults/CoverageReport/
          frontend/coverage/

  # å®‰å…¨æ€§æª¢æŸ¥
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    # å¾Œç«¯å®‰å…¨æ€§æª¢æŸ¥
    - name: Backend Security Scan
      run: |
        echo "=== å¾Œç«¯å®‰å…¨æ€§æª¢æŸ¥ ==="
        
        dotnet restore
        
        # ä¾è³´å®‰å…¨æ€§æª¢æŸ¥
        dotnet list package --vulnerable
        
        # ç¨‹å¼ç¢¼å®‰å…¨æ€§åˆ†æ
        dotnet tool install --global dotnet-security-scan
        dotnet security-scan
        
        echo "âœ… å¾Œç«¯å®‰å…¨æ€§æª¢æŸ¥å®Œæˆ"

    # å‰ç«¯å®‰å…¨æ€§æª¢æŸ¥
    - name: Frontend Security Scan
      run: |
        echo "=== å‰ç«¯å®‰å…¨æ€§æª¢æŸ¥ ==="
        cd frontend
        
        pnpm install --frozen-lockfile
        
        # ä¾è³´å®‰å…¨æ€§æª¢æŸ¥
        pnpm audit --audit-level high
        
        # ç¨‹å¼ç¢¼å®‰å…¨æ€§æª¢æŸ¥
        pnpm run security:check
        
        echo "âœ… å‰ç«¯å®‰å…¨æ€§æª¢æŸ¥å®Œæˆ"

  # æ•ˆèƒ½æª¢æŸ¥
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # å»ºç½®æ™‚é–“æª¢æŸ¥
    - name: Build Performance Check
      run: |
        echo "=== å»ºç½®æ•ˆèƒ½æª¢æŸ¥ ==="
        
        # è¨˜éŒ„å»ºç½®é–‹å§‹æ™‚é–“
        BUILD_START=$(date +%s)
        
        dotnet restore
        dotnet build --configuration Release --no-restore
        
        # è¨˜éŒ„å»ºç½®çµæŸæ™‚é–“
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "å»ºç½®æ™‚é–“: ${BUILD_TIME} ç§’"
        
        # æª¢æŸ¥å»ºç½®æ™‚é–“æ˜¯å¦åœ¨åˆç†ç¯„åœå…§
        if [ $BUILD_TIME -gt 300 ]; then
          echo "âš ï¸  è­¦å‘Š: å»ºç½®æ™‚é–“è¶…é 5 åˆ†é˜"
        else
          echo "âœ… å»ºç½®æ™‚é–“æ­£å¸¸"
        fi

    # å‰ç«¯å»ºç½®æ•ˆèƒ½æª¢æŸ¥
    - name: Frontend Build Performance
      run: |
        echo "=== å‰ç«¯å»ºç½®æ•ˆèƒ½æª¢æŸ¥ ==="
        cd frontend
        
        pnpm install --frozen-lockfile
        
        # è¨˜éŒ„å»ºç½®é–‹å§‹æ™‚é–“
        BUILD_START=$(date +%s)
        
        pnpm build
        
        # è¨˜éŒ„å»ºç½®çµæŸæ™‚é–“
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "å‰ç«¯å»ºç½®æ™‚é–“: ${BUILD_TIME} ç§’"
        
        if [ $BUILD_TIME -gt 120 ]; then
          echo "âš ï¸  è­¦å‘Š: å‰ç«¯å»ºç½®æ™‚é–“è¶…é 2 åˆ†é˜"
        else
          echo "âœ… å‰ç«¯å»ºç½®æ™‚é–“æ­£å¸¸"
        fi

  # PR è©•è«–èˆ‡ç¸½çµ
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, security-scan, performance-check]
    if: always()
    
    steps:
    - name: Generate PR Summary
      uses: actions/github-script@v7
      with:
        script: |
          const { data: checks } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.payload.pull_request.head.sha,
          });
          
          const summary = {
            codeQuality: checks.check_runs.find(c => c.name === 'Code Quality Check')?.conclusion,
            testCoverage: checks.check_runs.find(c => c.name === 'Test Coverage Check')?.conclusion,
            securityScan: checks.check_runs.find(c => c.name === 'Security Scan')?.conclusion,
            performanceCheck: checks.check_runs.find(c => c.name === 'Performance Check')?.conclusion,
          };
          
          const allPassed = Object.values(summary).every(result => result === 'success');
          const hasFailures = Object.values(summary).some(result => result === 'failure');
          
          let commentBody = `## ğŸ” Pull Request å“è³ªæª¢æŸ¥çµæœ
          
          ### ğŸ“Š æª¢æŸ¥é …ç›®
          - **ç¨‹å¼ç¢¼å“è³ª**: ${summary.codeQuality === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
          - **æ¸¬è©¦è¦†è“‹ç‡**: ${summary.testCoverage === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
          - **å®‰å…¨æ€§æª¢æŸ¥**: ${summary.securityScan === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
          - **æ•ˆèƒ½æª¢æŸ¥**: ${summary.performanceCheck === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
          
          ### ğŸ“ˆ æ•´é«”è©•ä¼°
          ${allPassed ? 'ğŸ‰ **æ‰€æœ‰æª¢æŸ¥éƒ½é€šéäº†ï¼**' : hasFailures ? 'âš ï¸ **ç™¼ç¾å•é¡Œéœ€è¦ä¿®å¾©**' : 'âš ï¸ **éƒ¨åˆ†æª¢æŸ¥æœªå®Œæˆ**'}
          
          ### ğŸ“‹ å»ºè­°
          ${allPassed ? '- ç¨‹å¼ç¢¼å“è³ªè‰¯å¥½ï¼Œå¯ä»¥é€²è¡Œåˆä½µ' : '- è«‹ä¿®å¾©å¤±æ•—çš„æª¢æŸ¥é …ç›®å¾Œå†åˆä½µ'}
          
          ---
          *æ­¤è©•è«–ç”±è‡ªå‹•åŒ–å“è³ªæª¢æŸ¥ç³»çµ±ç”Ÿæˆ*`;
          
          // å°‹æ‰¾ç¾æœ‰çš„æ©Ÿå™¨äººè©•è«–
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('## ğŸ” Pull Request å“è³ªæª¢æŸ¥çµæœ')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody,
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody,
            });
          }
          
          // å¦‚æœæ‰€æœ‰æª¢æŸ¥éƒ½é€šéï¼Œæ·»åŠ æ¨™ç±¤
          if (allPassed) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['quality-check-passed'],
            });
          } else if (hasFailures) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['quality-check-failed'],
            });
          }