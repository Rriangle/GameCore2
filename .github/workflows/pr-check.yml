name: Pull Request Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'

jobs:
  # =============================================================================
  # PR æ¨™é¡Œå’Œæè¿°æª¢æŸ¥
  # =============================================================================
  pr-title-check:
    name: PR Title & Description Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          test
          chore
        requireScope: false
        requireBody: true
        requireFooter: false

    - name: Check PR description
      run: |
        if [ -z "${{ github.event.pull_request.body }}" ]; then
          echo "âŒ PR æè¿°ä¸èƒ½ç‚ºç©º"
          exit 1
        fi
        
        if [ ${#github.event.pull_request.body} -lt 50 ]; then
          echo "âŒ PR æè¿°è‡³å°‘éœ€è¦ 50 å­—å…ƒ"
          exit 1
        fi
        
        echo "âœ… PR æè¿°æª¢æŸ¥é€šé"

  # =============================================================================
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  # =============================================================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Install .NET dependencies
      run: dotnet restore

    - name: Install frontend dependencies
      run: |
        cd frontend
        pnpm install --frozen-lockfile

    - name: Check .NET formatting
      run: dotnet format --verify-no-changes

    - name: Check .NET build
      run: dotnet build --no-restore --configuration Release

    - name: Check frontend build
      run: |
        cd frontend
        pnpm run build

    - name: Run .NET analyzers
      run: dotnet build --no-restore --configuration Release --verbosity quiet

    - name: Run frontend linting
      run: |
        cd frontend
        pnpm run lint

    - name: Run frontend type check
      run: |
        cd frontend
        pnpm run type-check

  # =============================================================================
  # ç¨‹å¼ç¢¼è¦†è“‹ç‡æª¢æŸ¥
  # =============================================================================
  code-coverage:
    name: Code Coverage Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: "YourStrong@Passw0rd"
          ACCEPT_EULA: "Y"
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 1433:1433

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Install dependencies
      run: |
        dotnet restore
        cd frontend && pnpm install --frozen-lockfile

    - name: Run backend tests with coverage
      run: |
        dotnet test --no-build --verbosity normal --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=backend-test-results.trx"

    - name: Run frontend tests with coverage
      run: |
        cd frontend
        pnpm run test:unit --coverage --reporter=verbose

    - name: Check backend coverage threshold
      run: |
        # æª¢æŸ¥å¾Œç«¯æ¸¬è©¦è¦†è“‹ç‡æ˜¯å¦é”åˆ° 80%
        coverage_file=$(find TestResults -name "coverage.cobertura.xml" | head -1)
        if [ -z "$coverage_file" ]; then
          echo "âŒ æ‰¾ä¸åˆ°è¦†è“‹ç‡å ±å‘Š"
          exit 1
        fi
        
        echo "âœ… å¾Œç«¯æ¸¬è©¦è¦†è“‹ç‡å ±å‘Šç”ŸæˆæˆåŠŸ"

    - name: Check frontend coverage threshold
      run: |
        cd frontend
        if [ ! -f "coverage/lcov.info" ]; then
          echo "âŒ æ‰¾ä¸åˆ°å‰ç«¯è¦†è“‹ç‡å ±å‘Š"
          exit 1
        fi
        
        echo "âœ… å‰ç«¯æ¸¬è©¦è¦†è“‹ç‡å ±å‘Šç”ŸæˆæˆåŠŸ"

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          TestResults/
          frontend/coverage/

  # =============================================================================
  # å®‰å…¨æ€§æª¢æŸ¥
  # =============================================================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Install dependencies
      run: |
        dotnet restore
        cd frontend && pnpm install --frozen-lockfile

    - name: Run .NET security scan
      run: |
        dotnet tool install --global dotnet-security-scan
        dotnet security-scan

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level moderate

    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}

    - name: Check for dependency vulnerabilities
      run: |
        cd frontend
        if npm audit --audit-level high; then
          echo "âœ… å‰ç«¯ä¾è³´å®‰å…¨æ€§æª¢æŸ¥é€šé"
        else
          echo "âš ï¸ ç™¼ç¾é«˜é¢¨éšªä¾è³´æ¼æ´ï¼Œè«‹æ›´æ–°ç›¸é—œå¥—ä»¶"
          exit 1
        fi

  # =============================================================================
  # æª”æ¡ˆå¤§å°æª¢æŸ¥
  # =============================================================================
  file-size-check:
    name: File Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for large files
      run: |
        echo "æª¢æŸ¥å¤§æª”æ¡ˆ..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è¶…é 50MB çš„æª”æ¡ˆ
        large_files=$(find . -type f -size +50M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./bin/*" -not -path "./obj/*")
        
        if [ -n "$large_files" ]; then
          echo "âŒ ç™¼ç¾å¤§æª”æ¡ˆï¼Œè«‹æª¢æŸ¥æ˜¯å¦éœ€è¦åŠ å…¥ .gitignoreï¼š"
          echo "$large_files"
          exit 1
        fi
        
        echo "âœ… æª”æ¡ˆå¤§å°æª¢æŸ¥é€šé"

    - name: Check build artifacts size
      run: |
        echo "æª¢æŸ¥å»ºç½®ç”¢ç‰©å¤§å°..."
        
        # æ¨¡æ“¬å»ºç½®ä¸¦æª¢æŸ¥ç”¢ç‰©å¤§å°
        dotnet build --configuration Release --no-restore --verbosity quiet
        
        # æª¢æŸ¥ .NET å»ºç½®ç”¢ç‰©
        dotnet_size=$(du -sh src/*/bin/Release/net8.0/ 2>/dev/null | awk '{sum+=$1} END {print sum}')
        echo "å¾Œç«¯å»ºç½®ç”¢ç‰©å¤§å°: $dotnet_size"
        
        # æª¢æŸ¥å‰ç«¯å»ºç½®ç”¢ç‰©
        cd frontend
        pnpm run build --silent
        frontend_size=$(du -sh dist/ 2>/dev/null | awk '{print $1}')
        echo "å‰ç«¯å»ºç½®ç”¢ç‰©å¤§å°: $frontend_size"

  # =============================================================================
  # ä¾è³´æª¢æŸ¥
  # =============================================================================
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Check .NET dependencies
      run: |
        echo "æª¢æŸ¥ .NET ä¾è³´..."
        dotnet list package --outdated
        
        # æª¢æŸ¥æ˜¯å¦æœ‰éæ™‚çš„ä¾è³´
        outdated_count=$(dotnet list package --outdated | grep -c ">" || true)
        if [ "$outdated_count" -gt 0 ]; then
          echo "âš ï¸ ç™¼ç¾ $outdated_count å€‹éæ™‚çš„ä¾è³´å¥—ä»¶"
        else
          echo "âœ… .NET ä¾è³´æª¢æŸ¥é€šé"
        fi

    - name: Check frontend dependencies
      run: |
        cd frontend
        echo "æª¢æŸ¥å‰ç«¯ä¾è³´..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰éæ™‚çš„ä¾è³´
        pnpm outdated || echo "âœ… å‰ç«¯ä¾è³´æª¢æŸ¥é€šé"

    - name: Check for known vulnerabilities
      run: |
        cd frontend
        echo "æª¢æŸ¥å·²çŸ¥æ¼æ´..."
        
        # ä½¿ç”¨ npm audit æª¢æŸ¥æ¼æ´
        if npm audit --audit-level moderate; then
          echo "âœ… å‰ç«¯ä¾è³´å®‰å…¨æ€§æª¢æŸ¥é€šé"
        else
          echo "âš ï¸ ç™¼ç¾ä¾è³´æ¼æ´ï¼Œè«‹æª¢æŸ¥ä¸¦æ›´æ–°"
        fi

  # =============================================================================
  # PR ç‹€æ…‹å ±å‘Š
  # =============================================================================
  pr-report:
    name: PR Status Report
    runs-on: ubuntu-latest
    needs: [pr-title-check, code-quality, code-coverage, security-check, file-size-check, dependency-check]
    if: always()
    
    steps:
    - name: Generate PR report
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('## ğŸ” PR æª¢æŸ¥å ±å‘Š')
          );
          
          const results = {
            'PR æ¨™é¡Œæª¢æŸ¥': '${{ needs.pr-title-check.result }}',
            'ç¨‹å¼ç¢¼å“è³ª': '${{ needs.code-quality.result }}',
            'ç¨‹å¼ç¢¼è¦†è“‹ç‡': '${{ needs.code-coverage.result }}',
            'å®‰å…¨æ€§æª¢æŸ¥': '${{ needs.security-check.result }}',
            'æª”æ¡ˆå¤§å°æª¢æŸ¥': '${{ needs.file-size-check.result }}',
            'ä¾è³´æª¢æŸ¥': '${{ needs.dependency-check.result }}'
          };
          
          const allPassed = Object.values(results).every(result => result === 'success');
          const status = allPassed ? 'âœ… é€šé' : 'âŒ å¤±æ•—';
          
          const commentBody = `## ğŸ” PR æª¢æŸ¥å ±å‘Š
          
          **æ•´é«”ç‹€æ…‹**: ${status}
          
          ### ğŸ“‹ æª¢æŸ¥çµæœ
          ${Object.entries(results).map(([name, result]) => {
            const icon = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
            return `- ${icon} **${name}**: ${result === 'success' ? 'é€šé' : result === 'failure' ? 'å¤±æ•—' : 'è·³é'}`;
          }).join('\n')}
          
          ### ğŸ“Š è©³ç´°è³‡è¨Š
          - **åˆ†æ”¯**: \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`
          - **æäº¤**: \`${{ github.sha }}\`
          - **è§¸ç™¼è€…**: ${{ github.actor }}
          
          ### ğŸ”§ ä¸‹ä¸€æ­¥
          ${allPassed 
            ? 'ğŸ‰ æ‰€æœ‰æª¢æŸ¥éƒ½é€šéäº†ï¼å¯ä»¥é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥ã€‚' 
            : 'âš ï¸ è«‹ä¿®å¾©å¤±æ•—çš„æª¢æŸ¥é …ç›®å¾Œé‡æ–°æäº¤ã€‚'
          }
          
          ---
          *æ­¤å ±å‘Šç”± PR æª¢æŸ¥å·¥ä½œæµç¨‹è‡ªå‹•ç”Ÿæˆ*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody,
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody,
            });
          }

    - name: Set PR status
      if: always()
      run: |
        # æª¢æŸ¥æ‰€æœ‰å·¥ä½œæ˜¯å¦æˆåŠŸ
        if [ "${{ needs.pr-title-check.result }}" = "success" ] && \
           [ "${{ needs.code-quality.result }}" = "success" ] && \
           [ "${{ needs.code-coverage.result }}" = "success" ] && \
           [ "${{ needs.security-check.result }}" = "success" ] && \
           [ "${{ needs.file-size-check.result }}" = "success" ] && \
           [ "${{ needs.dependency-check.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰ PR æª¢æŸ¥éƒ½é€šéäº†"
          exit 0
        else
          echo "âŒ éƒ¨åˆ† PR æª¢æŸ¥å¤±æ•—"
          exit 1
        fi